<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Game View</title>
  <style>
    .panel { display: none; margin-top: 1rem; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <!-- LOGIN PANEL -->
  <div id="login-panel">
    <h2>Student Login</h2>
    <input type="text" id="Idnumber" placeholder="ID Number"><br>
    <input type="password" id="passWord" placeholder="Password"><br>
    <button id="loginBtn">Login</button>
    <p id="loginMessage" style="color:red;"></p>
  </div>

  <!-- GROUP INFO PANEL -->
  <div id="group-panel" class="panel">
    <h3>Your Group</h3>
    <div id="group-info"></div>
  </div>

  <!-- QUESTIONS LIST PANEL -->
  <div id="questions-panel" class="panel">
    <h3>Challenge Questions</h3>
    <ul id="questions-list"></ul>
  </div>

  <!-- GAME RECORDS PANEL -->
  <div id="gameRecord-panel" class="panel">
    <h3>Game Records</h3>
    <div id="game-info"></div>
  </div>

  <!-- FIREBASE MODULE + APP LOGIC -->
  <script type="module">
    const urlParams = new URLSearchParams(window.location.search);
    const attendanceRecordId = urlParams.get("attendanceRecord");

    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js");
    const { getFirestore, collection, doc, getDoc, getDocs, query, where } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js");

    const firebaseConfig = {
      apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
      authDomain: "jlvcpa-quizzes.firebaseapp.com",
      projectId: "jlvcpa-quizzes",
      storageBucket: "jlvcpa-quizzes.appspot.com",
      messagingSenderId: "629158256557",
      appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const id = document.getElementById("Idnumber").value.trim();
      const pw = document.getElementById("passWord").value.trim();

      const studentsRef = collection(db, "students");
      const q = query(studentsRef, where("Idnumber", "==", id), where("passWord", "==", pw));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        document.getElementById("loginMessage").textContent = "Invalid ID or password.";
        return;
      }

      const student = snapshot.docs[0].data();
      const fullName = student.fullName;

      document.getElementById("login-panel").style.display = "none";

      await loadGroup(fullName);
      await loadQuestions();
    });

    async function loadGroup(fullName) {
      const groupNames = ["Group1", "Group2", "Group3"];
      let foundGroup = null;

      for (const group of groupNames) {
        const docID = `${attendanceRecordId}-${group}`;
        const groupDoc = await getDoc(doc(db, "groupings", docID));

        if (groupDoc.exists()) {
          const data = groupDoc.data();
          if (data.members.includes(fullName)) {
            foundGroup = group;
            break;
          }
        }
      }

      if (foundGroup) {
        document.getElementById("group-info").textContent = `Group Name: ${foundGroup}`;
        document.getElementById("group-panel").style.display = "block";
        document.getElementById("questions-panel").style.display = "block";
      } else {
        document.getElementById("group-info").textContent = "Group not found.";
        document.getElementById("group-panel").style.display = "block";
      }
    }

    async function loadQuestions() {
      const docID = `${attendanceRecordId}_groupQB`;
      const qbDoc = await getDoc(doc(db, "groupingsQuestionBank", docID));

      const questionsList = document.getElementById("questions-list");
      questionsList.innerHTML = "";

      if (qbDoc.exists()) {
        const data = qbDoc.data();
        const questions = data.questions || [];

        questions.forEach((q, index) => {
          const li = document.createElement("li");
          li.textContent = `Q${index + 1}: ${q.question || "[No question text]"}`;
          questionsList.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        li.textContent = "No questions found for this attendance record.";
        questionsList.appendChild(li);
      }
    }

    function startGame() {
      document.getElementById("questions-panel").style.display = "none";
      document.getElementById("gameRecord-panel").style.display = "block";
      document.getElementById("game-info").textContent = "Game has started! You'll see your performance here.";
    }

    window.startGame = startGame;
  </script>
</body>
</html>
