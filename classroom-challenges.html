<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Group Assignment</title>
  <style>
    body {
      body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  height: 100vh;
}

.main-container {
  display: flex;
  height: 100vh;
}

.left-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
}

.group-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.group-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  border: 1px solid #ccc;
  padding: 10px;
  box-sizing: border-box;
}

.allQuestions-panel {
  flex: 1;
  border: 1px solid #ccc;
  padding: 10px;
  box-sizing: border-box;
  overflow-y: auto;
}

.student-panel {
  width: 16%;
  border-left: 1px solid #ccc;
  padding: 10px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

.header {
  font-weight: bold;
  font-size: 18px;
  margin-bottom: 10px;
  color: #007acc;
}

.groupMembers {
  flex: 1;
  background-color: #f9f9f9;
  border: 1px solid #ccc;
  padding: 8px;
  margin-bottom: 10px;
  overflow-y: auto;
}

.gameRecords {
  flex: 2;
  height: 100px;
  background-color: #e8f0fe;
  border: 1px solid #007acc;
  padding: 8px;
}

.studentList {
  flex: 1;
  background-color: #fff;
  border: 1px solid #ccc;
  padding: 8px;
  overflow-y: auto;
}

.hidden {
  display: none;
}

button {
  margin-top: 10px;       /* Keeps the top spacing */
  margin-left: 20px;      /* Adds space to the left */
  margin-right: 20px;     /* Adds space to the right */
  padding: 6px 12px;
  font-size: 14px;
}
      #startGameBtn {
  width: 50px;            /* Equal width */
  height: 50px;           /* Equal height */
  padding: 0;             /* Remove extra spacing */
  font-size: 18px;        /* Adjust text/icon size */
  text-align: center;     /* Center content */
  border-radius: 8px;     /* Optional: rounded corners */
  display: inline-block;  /* Ensures proper layout */
}

      .student {
  padding: 6px;
  margin-bottom: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.student.active {
  background-color: #e0f7fa;
  color: #00796b;
  cursor: pointer;
}

.question-item {
  margin-bottom: 10px;
  padding: 8px;
  background: #f9f9f9;
  border-radius: 6px;
}

      .group-row {
  display: flex;
  gap: 20px;
  padding: 20px;
}

.panel.group-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  max-height: calc(50vh - 1in); /* Half of viewport minus footer */
  overflow-y: auto;
}

.gameRecords {
  flex: 1;
  padding: 10px;
  background: #eef;
  border-top: 1px dashed #aaa;
  overflow-y: auto;
}
      
.student.inactive {
  background-color: #f0f0f0;
  color: #999;
  pointer-events: none;
}
  </style>
</head>
<body>
<body>
  <div class="main-container">
    <div class="left-column">
      
      <div class="groupButtons">
          <button onclick="saveGroups()">Save Groups</button>
          <button onclick="showGroups()">Show Groups</button>
        </div>
      
      <div class="group-row">
        <div class="panel group-panel">
          <div class="header">Group 1</div>
          <div class="groupMembers" id="group1Members">[Group 1 members]</div>
          <div class="gameRecords hidden" id="group1Records">[Game Records]</div>
        </div>
        
        <div class="panel group-panel">
          <div class="header">Group 2</div>
          <div class="groupMembers" id="group2Members">[Group 2 members]</div>
          <div class="gameRecords hidden" id="group2Records">[Game Records]</div>
        </div>
        
        <div class="panel group-panel">
          <div class="header">Group 3</div>
          <div class="groupMembers" id="group3Members">[Group 3 members]</div>
          <div class="gameRecords hidden" id="group3Records">[Game Records]</div>
        </div>
      </div>
          
      <div class="panel allQuestions-panel">
        <div class="panel gameButtons-panel">
           <button onclick="generateQuestions()">Generate Questions</button>
           <button onclick="showGeneratedQuestions()">Show Generated Questions</button>
           <button onclick="showGameRecords()">Show Game Dashboard</button>
           </div>
        <div class="header">All Questions</div>
        <div class="allQuestionsList" id="allQuestionsList">
          [All Questions for students discussion before the game starts will load here]
           </div>
      </div>
        <button hidden id="startGameBtn" onclick="startGame()">üéÆ Start Game</button>
        <div class="panel gameControls-panel">
          <button hidden id="prevQuestionBtn" onclick="prevQuestion()">‚¨ÖÔ∏è Previous</button>
          <button hidden id="nextQuestionBtn" onclick="nextQuestion()">‚û°Ô∏è Next</button>
          </div>
    </div>

    <div class="panel student-panel">
      <div class="header">Student List</div>
      <label for="selectAttendanceRecord">Section:</label>
      <select id="selectAttendanceRecord">
        <option value="">-- Select Attendance Record --</option>
      </select>
      <button id="generateLinkBtn">Generate Game View Link</button>
       <a id="gameViewLink" href="#" target="_blank" style="display:none;">Open Game View</a>
      <div class="studentList" id="studentList">[Students will load here]</div>
      <button onclick="createGroups()">Create Groups</button>
    </div>
    
  </div>
</body>
  
<script type="module">
(async () => {
  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js");
  const { getFirestore, collection, getDocs, doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js");

  const firebaseConfig = {
    apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
    authDomain: "jlvcpa-quizzes.firebaseapp.com",
    projectId: "jlvcpa-quizzes",
    storageBucket: "jlvcpa-quizzes.appspot.com",
    messagingSenderId: "629158256557",
    appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const selectAttendance = document.getElementById("selectAttendanceRecord");
  const studentList = document.getElementById("studentList");

  // üîç Fetch 3 most recent attendance records
  async function loadRecentAttendanceRecords() {
    const snapshot = await getDocs(collection(db, "attendance"));
    const records = [];

    snapshot.forEach(doc => {
      const [section, date] = doc.id.split("_");
      records.push({ id: doc.id, section, date });
    });

    // Sort by date descending
    records.sort((a, b) => new Date(b.date) - new Date(a.date));

    // Take top 3
    const recent = records.slice(0, 3);

    recent.forEach(record => {
      const option = document.createElement("option");
      option.value = record.id;
      option.textContent = `${record.section} - ${record.date}`;
      selectAttendance.appendChild(option);
    });
  }

  // ‚úÖ Corrected: Load students from array field in attendance document
  async function loadStudents(docId) {
    studentList.innerHTML = ""; // Clear previous

    const attendanceDoc = await getDoc(doc(db, "attendance", docId));
    if (!attendanceDoc.exists()) {
      console.error("Attendance record not found:", docId);
      return;
    }

    const data = attendanceDoc.data();
    const students = data.students || [];

    students.forEach(student => {
      const { fullName, status } = student;
      const div = document.createElement("div");
      div.className = `student ${status === "A" ? "inactive" : "active"}`;
      div.textContent = `${fullName} - ${status}`;
      div.dataset.fullName = fullName;
      div.dataset.status = status;
      studentList.appendChild(div);
    });
  }

  // üéØ Randomly assign active students to groups
  window.createGroups = function () {
    const activeStudents = Array.from(document.querySelectorAll(".student.active"));
    const shuffled = activeStudents.sort(() => Math.random() - 0.5);

    const groups = [[], [], []];
    shuffled.forEach((student, i) => {
      groups[i % 3].push(student);
      student.classList.add("inactive"); // Gray out after assignment
      student.classList.remove("active");
    });

    // Populate group panels
    document.getElementById("group1Members").innerHTML = groups[0].map(s => s.textContent).join("<br>");
    document.getElementById("group2Members").innerHTML = groups[1].map(s => s.textContent).join("<br>");
    document.getElementById("group3Members").innerHTML = groups[2].map(s => s.textContent).join("<br>");
  };

  // START OF GENERATE LINK LOGIC
  window.generateStudentLink = async function () {
  const select = document.getElementById("selectAttendanceRecord");
  const selectedDocId = select.value;

  if (!selectedDocId) {
    document.getElementById("generatedLinkDisplay").textContent = "Please select an attendance record.";
    return;
  }

  const link = `studentsGameView.html?attendanceRecord=${encodeURIComponent(selectedDocId)}`;

  try {
    await navigator.clipboard.writeText(link);
    document.getElementById("generatedLinkDisplay").innerHTML = `
      ‚úÖ Link copied to clipboard!<br>
      <a href="${link}" target="_blank">${link}</a>
    `;
  } catch (err) {
    document.getElementById("generatedLinkDisplay").textContent = "Failed to copy link. Here's the URL: " + link;
  }
}; // END OF GENERATE LINK LOGIC
  // ‚úÖ Save groups to Firestore
window.saveGroups = async function () {
  const attendanceDocID = selectAttendance.value;
  if (!attendanceDocID) {
    alert("Please select an attendance record.");
    return;
  }

  const groupRefs = ["Group1", "Group2", "Group3"].map(
    g => doc(db, "groupings", `${attendanceDocID}-${g}`)
  );

  const existing = await Promise.all(groupRefs.map(ref => getDoc(ref)));
  const alreadySaved = existing.every(docSnap => docSnap.exists());

  if (alreadySaved) {
    alert("Groups already saved. Click 'Show Groups' to view them.");
    return;
  }

  const group1 = document.getElementById("group1Members").innerHTML.split("<br>").filter(Boolean);
  const group2 = document.getElementById("group2Members").innerHTML.split("<br>").filter(Boolean);
  const group3 = document.getElementById("group3Members").innerHTML.split("<br>").filter(Boolean);

  await setDoc(doc(db, "groupings", `${attendanceDocID}-Group1`), {
    group: "Group1",
    members: group1,
    attendanceRef: attendanceDocID
  });
  await setDoc(doc(db, "groupings", `${attendanceDocID}-Group2`), {
    group: "Group2",
    members: group2,
    attendanceRef: attendanceDocID
  });
  await setDoc(doc(db, "groupings", `${attendanceDocID}-Group3`), {
    group: "Group3",
    members: group3,
    attendanceRef: attendanceDocID
  });

  alert("‚úÖ Groups saved successfully.");
};

// ‚úÖ Show saved groups from Firestore
window.showGroups = async function () {
  const attendanceDocID = selectAttendance.value;
  if (!attendanceDocID) {
    alert("Please select an attendance record.");
    return;
  }

  const groupIDs = ["Group1", "Group2", "Group3"].map(g => `${attendanceDocID}-${g}`);
  const groupData = await Promise.all(groupIDs.map(id => getDoc(doc(db, "groupings", id))));

  groupData.forEach((docSnap, i) => {
    const groupNum = i + 1;
    const container = document.getElementById(`group${groupNum}Members`);
    if (docSnap.exists()) {
      const data = docSnap.data();
      container.innerHTML = data.members.join("<br>");
    } else {
      container.innerHTML = "[No saved group found]";
    }
  });
};

  // ‚úÖ Generate and save 20 Constructed-Response questions
     window.generateQuestions = async function () {
         const attendanceDocID = selectAttendance.value;
         if (!attendanceDocID) {
           alert("Please select an attendance record.");
           return;
         }
         const snapshot = await getDocs(collection(db, "questionBank"));
         const allQuestions = [];
         snapshot.forEach(doc => {
           const data = doc.data();
           if (data.testType === "Constructed-Response") {
             allQuestions.push(data);
           }
         });
         const selectedQuestions = allQuestions.sort(() => Math.random() - 0.5).slice(0, 20);
         const docID = `${attendanceDocID}_groupQB`;
         await setDoc(doc(db, "groupingsQuestionBank", docID), {
           attendanceRef: attendanceDocID,
           questions: selectedQuestions,
           timestamp: Date.now()
         });
         renderQuestionsToPanel(selectedQuestions);
         alert("‚úÖ Questions generated and saved.");
       };

  // ‚úÖ Show previously generated questions
     window.showGeneratedQuestions = async function () {
         const attendanceDocID = selectAttendance.value;
         if (!attendanceDocID) {
           alert("Please select an attendance record.");
           return;
         }
  const docID = `${attendanceDocID}_groupQB`;
  const docSnap = await getDoc(doc(db, "groupingsQuestionBank", docID));
  if (!docSnap.exists()) {
    alert("No questions found for this attendance record.");
    return;
  }

  const data = docSnap.data();
  renderQuestionsToPanel(data.questions);
};

// ‚úÖ Load saved groups and questions when attendance changes
async function loadSavedGroupAndQuestions(attendanceDocID) {
  // Load groups
  const groupIDs = ["Group1", "Group2", "Group3"].map(g => `${attendanceDocID}-${g}`);
  const groupData = await Promise.all(groupIDs.map(id => getDoc(doc(db, "groupings", id))));

  groupData.forEach((docSnap, i) => {
    const groupNum = i + 1;
    const container = document.getElementById(`group${groupNum}Members`);
    if (docSnap.exists()) {
      const data = docSnap.data();
      container.innerHTML = data.members.join("<br>");
    } else {
      container.innerHTML = "[No saved group found]";
    }
  });

  // Load questions
  const qbDocID = `${attendanceDocID}_groupQB`;
  const qbSnap = await getDoc(doc(db, "groupingsQuestionBank", qbDocID));
  if (qbSnap.exists()) {
    const data = qbSnap.data();
    renderQuestionsToPanel(data.questions);
  } else {
    document.getElementById("allQuestionsList").innerHTML = "[No questions found]";
  }
  


} 
  // üß† Event listener for dropdown
  selectAttendance.addEventListener("change", async e => {
  const attendanceDocID = e.target.value;
  if (attendanceDocID) {
    await loadStudents(attendanceDocID); // Load student list
    await loadSavedGroupAndQuestions(attendanceDocID); // Load saved groups + questions
  }
});

window.showGameRecords = function () {
  // üîí Hide the entire All Questions panel
  const allQuestionsPanel = document.querySelector(".allQuestions-panel");
  if (allQuestionsPanel) {
    allQuestionsPanel.style.display = "none";
    // ‚úÖ Show Start Game button after loading
  document.getElementById("startGameBtn").hidden = false
  document.getElementById("prevQuestionBtn").hidden = false;
  document.getElementById("nextQuestionBtn").hidden = false;
  }
  // üéØ Show all group game record panels
  const groupRecordIDs = ["group1Records", "group2Records", "group3Records"];
  groupRecordIDs.forEach(id => {
    const panel = document.getElementById(id);
    if (panel) {
      panel.classList.remove("hidden");
      panel.style.display = "block";

      // Optional: Add a motivational header
      panel.innerHTML = `<div class="gameHeader">üéØ Get ready! Your group‚Äôs performance will be tracked here.</div>` + panel.innerHTML;
    }
  });
};

  // Render Questions to Panel
function renderQuestionsToPanel(questions) {
  const container = document.getElementById("allQuestionsList");
  container.innerHTML = ""; // Clear previous content

  questions.forEach((q, index) => {
    const div = document.createElement("div");
    div.className = "question-item";
    div.innerHTML = `<strong>Q${index + 1}:</strong> ${q.question || "[No question text]"}<hr>`;
    container.appendChild(div);
  });
} // End of render questions to panel

  // üöÄ Initialize
  loadRecentAttendanceRecords();
})();
</script>
  
<script type="module">
  document.getElementById("generateLinkBtn").addEventListener("click", () => {
    const select = document.getElementById("selectAttendanceRecord");
    const selectedDocId = select.value;

    if (!selectedDocId) {
      alert("Please select an attendance record.");
      return;
    }

    // üåê Full URL to hosted studentsGameView.html
    const baseUrl = "https://jlvcpa.github.io/dev.page/studentsGameView.html";
    const link = `${baseUrl}?attendanceRecord=${encodeURIComponent(selectedDocId)}`;

    // üéØ Update the anchor element
    const anchor = document.getElementById("gameViewLink");
    anchor.href = link;
    anchor.style.display = "inline-block";
    anchor.textContent = `Open Game View for ${selectedDocId}`;
  });
</script>

</body>
</html>
