<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Group Assignment</title>
  <style>
    body {
      body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  height: 100vh;
}

.main-container {
  display: flex;
  height: 100vh;
}

.left-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
}

.group-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.group-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  border: 1px solid #ccc;
  padding: 10px;
  box-sizing: border-box;
}

.allQuestions-panel {
  flex: 1;
  border: 1px solid #ccc;
  padding: 10px;
  box-sizing: border-box;
  overflow-y: auto;
}

.student-panel {
  width: 16%;
  border-left: 1px solid #ccc;
  padding: 10px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

.header {
  font-weight: bold;
  font-size: 18px;
  margin-bottom: 10px;
  color: #007acc;
}

.groupMembers {
  flex: 1;
  background-color: #f9f9f9;
  border: 1px solid #ccc;
  padding: 8px;
  margin-bottom: 10px;
  overflow-y: auto;
}

.gameRecords {
  height: 100px;
  background-color: #e8f0fe;
  border: 1px solid #007acc;
  padding: 8px;
}

.studentList {
  flex: 1;
  background-color: #fff;
  border: 1px solid #ccc;
  padding: 8px;
  overflow-y: auto;
}

.hidden {
  display: none;
}

button {
  margin-top: 10px;
  padding: 6px 12px;
  font-size: 14px;
}
      .student {
  padding: 6px;
  margin-bottom: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.student.active {
  background-color: #e0f7fa;
  color: #00796b;
  cursor: pointer;
}

.student.inactive {
  background-color: #f0f0f0;
  color: #999;
  pointer-events: none;
}
  </style>
</head>
<body>
<body>
  <div class="main-container">
    <div class="left-column">
      
      <div class="groupButtons">
          <button onclick="saveGroups()">Save Groups</button>
          <button onclick="showGroups()">Show Groups</button>
        </div>
      
      <div class="group-row">
        <div class="panel group-panel">
          <div class="header">Group 1</div>
          <div class="groupMembers" id="group1Members">[Group 1 members]</div>
          <div class="gameRecords hidden" id="group1Records">[Game Records]</div>
        </div>
        
        <div class="panel group-panel">
          <div class="header">Group 2</div>
          <div class="groupMembers" id="group2Members">[Group 2 members]</div>
          <div class="gameRecords hidden" id="group2Records">[Game Records]</div>
        </div>
        
        <div class="panel group-panel">
          <div class="header">Group 3</div>
          <div class="groupMembers" id="group3Members">[Group 3 members]</div>
          <div class="gameRecords hidden" id="group3Records">[Game Records]</div>
        </div>
      </div>
      
      <div class="panel gameButtons-panel">
        
        <button onclick="generateQuiz()">Generate Quiz</button>
        <button onclick="showQuestions()">Show Questions</button>
        <button onclick="StartGame()">Start Game</button>
      </div>
      
      <div class="panel allQuestions-panel">
        <div class="header">All Questions</div>
        <div class="allQuestionsList" id="allQuestionsList">
          [All Questions for students discussion before the game starts will load here]
        </div>
      </div>
      
    </div>

    <div class="panel student-panel">
      <div class="header">Student List</div>
      <label for="selectAttendanceRecord">Section:</label>
      <select id="selectAttendanceRecord">
        <option value="">-- Select Attendance Record --</option>
      </select>
      <div class="studentList" id="studentList">[Students will load here]</div>
      <button onclick="createGroups()">Create Groups</button>
    </div>
    
  </div>
</body>
  
<script type="module">
(async () => {
  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js");
  const { getFirestore, collection, getDocs, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js");

  const firebaseConfig = {
    apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
    authDomain: "jlvcpa-quizzes.firebaseapp.com",
    projectId: "jlvcpa-quizzes",
    storageBucket: "jlvcpa-quizzes.appspot.com",
    messagingSenderId: "629158256557",
    appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const selectAttendance = document.getElementById("selectAttendanceRecord");
  const studentList = document.getElementById("studentList");

  // 🔍 Fetch 3 most recent attendance records
  async function loadRecentAttendanceRecords() {
    const snapshot = await getDocs(collection(db, "attendance"));
    const records = [];

    snapshot.forEach(doc => {
      const [section, date] = doc.id.split("_");
      records.push({ id: doc.id, section, date });
    });

    // Sort by date descending
    records.sort((a, b) => new Date(b.date) - new Date(a.date));

    // Take top 3
    const recent = records.slice(0, 3);

    recent.forEach(record => {
      const option = document.createElement("option");
      option.value = record.id;
      option.textContent = `${record.section} - ${record.date}`;
      selectAttendance.appendChild(option);
    });
  }

  // ✅ Corrected: Load students from array field in attendance document
  async function loadStudents(docId) {
    studentList.innerHTML = ""; // Clear previous

    const attendanceDoc = await getDoc(doc(db, "attendance", docId));
    if (!attendanceDoc.exists()) {
      console.error("Attendance record not found:", docId);
      return;
    }

    const data = attendanceDoc.data();
    const students = data.students || [];

    students.forEach(student => {
      const { fullName, status } = student;
      const div = document.createElement("div");
      div.className = `student ${status === "A" ? "inactive" : "active"}`;
      div.textContent = `${fullName} - ${status}`;
      div.dataset.fullName = fullName;
      div.dataset.status = status;
      studentList.appendChild(div);
    });
  }

  // 🎯 Randomly assign active students to groups
  window.createGroups = function () {
    const activeStudents = Array.from(document.querySelectorAll(".student.active"));
    const shuffled = activeStudents.sort(() => Math.random() - 0.5);

    const groups = [[], [], []];
    shuffled.forEach((student, i) => {
      groups[i % 3].push(student);
      student.classList.add("inactive"); // Gray out after assignment
      student.classList.remove("active");
    });

    // Populate group panels
    document.getElementById("group1Members").innerHTML = groups[0].map(s => s.textContent).join("<br>");
    document.getElementById("group2Members").innerHTML = groups[1].map(s => s.textContent).join("<br>");
    document.getElementById("group3Members").innerHTML = groups[2].map(s => s.textContent).join("<br>");
  };

  // 🧠 Event listener for dropdown
  selectAttendance.addEventListener("change", e => {
    if (e.target.value) {
      loadStudents(e.target.value);
    }
  });

  // 🚀 Initialize
  loadRecentAttendanceRecords();
})();
</script>

</body>
</html>
