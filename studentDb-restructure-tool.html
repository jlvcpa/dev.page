<!DOCTYPE html>
<html>
<head>
  <title>Student ID Migration & Cleanup Tool</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    button { margin-top: 1rem; padding: 0.5rem 1rem; }
    ul { list-style: none; padding: 0; }
    li { padding: 4px; cursor: pointer; }
    li.selected { background-color: #d0ebff; }
    #status { margin-top: 1rem; font-weight: bold; color: #333; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      initializeFirestore,
      collection,
      getDocs,
      doc,
      setDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 🔐 Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ✅ Enable long polling to avoid transport errors
    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, {
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });

    let studentsData = [];
    let mismatchedDocs = [];

    async function fetchStudents() {
      const status = document.getElementById("status");
      status.textContent = "⏳ Fetching students...";

      try {
        const snapshot = await getDocs(collection(db, "students"));
        console.log("✅ Fetched", snapshot.size, "students");

        studentsData = [];
        mismatchedDocs = [];

        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const docId = docSnap.id;
          const idnumber = data.Idnumber;

          const student = { docId, ...data };
          studentsData.push(student);

          if (docId !== idnumber && idnumber) {
            mismatchedDocs.push(student);
          }
        }

        displayMismatched();
        status.textContent = `✅ Loaded ${studentsData.length} students. ${mismatchedDocs.length} mismatched.`;
      } catch (error) {
        console.error("❌ Failed to fetch students:", error);
        status.textContent = `❌ Fetch failed: ${error.message}. Try refreshing or checking your network.`;
      }
    }

    function displayMismatched() {
      const list = document.getElementById("mismatchedList");
      list.innerHTML = "";

      mismatchedDocs.forEach((student, index) => {
        const li = document.createElement("li");
        li.textContent = `${student.FirstName} ${student.LastName} (${student.docId})`;
        li.dataset.index = index;
        li.onclick = handleSelect;
        list.appendChild(li);
      });
    }

    let lastSelectedIndex = null;

    function handleSelect(e) {
      const index = parseInt(e.target.dataset.index);
      const items = document.querySelectorAll("#mismatchedList li");

      if (e.shiftKey && lastSelectedIndex !== null) {
        const [start, end] = [lastSelectedIndex, index].sort((a, b) => a - b);
        for (let i = start; i <= end; i++) {
          items[i].classList.add("selected");
        }
      } else {
        e.target.classList.toggle("selected");
        lastSelectedIndex = index;
      }
    }

    async function migrateStudents() {
      const status = document.getElementById("status");
      status.textContent = "⏳ Migrating students...";

      let migrated = 0;

      try {
        for (const student of studentsData) {
          const { Idnumber, ...rest } = student;
          if (!Idnumber) continue;

          const newRef = doc(db, "students", Idnumber);
          await setDoc(newRef, rest);
          migrated++;
        }

        status.textContent = `✅ Migrated ${migrated} students using Idnumber as document ID.`;
      } catch (error) {
        console.error("❌ Migration failed:", error);
        status.textContent = `❌ Migration failed: ${error.message}`;
      }
    }

    async function deleteSelected() {
      const selectedItems = document.querySelectorAll("#mismatchedList li.selected");
      if (selectedItems.length === 0) {
        alert("⚠️ No students selected for deletion.");
        return;
      }

      if (!confirm(`Are you sure you want to delete ${selectedItems.length} selected student documents?`)) {
        return;
      }

      const status = document.getElementById("status");
      status.textContent = "⏳ Deleting selected documents...";

      let deleted = 0;

      try {
        for (const item of selectedItems) {
          const index = parseInt(item.dataset.index);
          const student = mismatchedDocs[index];
          await deleteDoc(doc(db, "students", student.docId));
          deleted++;
        }

        status.textContent = `🗑️ Deleted ${deleted} mismatched student documents.`;
        await fetchStudents(); // Refresh list
      } catch (error) {
        console.error("❌ Deletion failed:", error);
        status.textContent = `❌ Deletion failed: ${error.message}`;
      }
    }

    window.runFetch = fetchStudents;
    window.runMigration = migrateStudents;
    window.runDelete = deleteSelected;
  </script>
</head>
<body>
  <h2>🧩 Student ID Migration & Cleanup Tool</h2>
  <p>This tool migrates student documents using their <strong>Idnumber</strong> as the document ID and helps clean up mismatched records.</p>

  <button onclick="runFetch()">🔍 Fetch Students</button>
  <button onclick="runMigration()">📥 Migrate to Idnumber</button>
  <button onclick="runDelete()">🗑️ Delete Selected</button>

  <div id="status"></div>

  <h3>Mismatched Documents (Doc ID ≠ Idnumber)</h3>
  <ul id="mismatchedList"></ul>
</body>
</html>
