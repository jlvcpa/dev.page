<!DOCTYPE html>
<html>
<head>
  <title>Student ID Migration Tool</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      initializeFirestore,
      collection,
      getDocs,
      doc,
      setDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 🔐 Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ✅ Initialize Firebase with long polling to avoid transport errors
    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, {
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });

    async function migrateStudents(deleteOld = false) {
      const resultEl = document.getElementById("result");
      resultEl.innerText = "⏳ Migrating students...";

      try {
        const studentsSnapshot = await getDocs(collection(db, "students"));
        let migrated = 0, skipped = 0;

        for (const docSnap of studentsSnapshot.docs) {
          const data = docSnap.data();
          const idnumber = data.Idnumber;

          if (!idnumber) {
            console.warn(`⚠️ Skipping student with missing Idnumber: ${docSnap.id}`);
            skipped++;
            continue;
          }

          const newRef = doc(db, "students", idnumber);
          await setDoc(newRef, data);
          migrated++;

          if (deleteOld) {
            await deleteDoc(docSnap.ref);
          }
        }

        resultEl.innerText =
          `✅ Migration complete.\nMigrated: ${migrated}\nSkipped (missing Idnumber): ${skipped}`;
      } catch (error) {
        console.error("❌ Migration failed:", error);
        resultEl.innerText = `❌ Migration failed: ${error.message}`;
      }
    }

    window.runMigration = () => {
      const deleteOld = document.getElementById("deleteOld").checked;
      migrateStudents(deleteOld);
    };
  </script>
</head>
<body style="font-family: sans-serif; padding: 2rem;">
  <h2>🧩 Student ID Migration Utility</h2>
  <p>This tool copies each student document to a new one using their <strong>Idnumber</strong> as the document ID.</p>

  <label>
    <input type="checkbox" id="deleteOld" />
    Delete old documents after migration
  </label>
  <br><br>
  <button onclick="runMigration()" style="padding: 0.5rem 1rem;">Run Migration</button>

  <pre id="result" style="margin-top: 20px; background: #f4f4f4; padding: 1rem; border-radius: 5px;"></pre>
</body>
</html>
