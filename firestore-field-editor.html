<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Firestore Explorer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
      background: #f0f0f0;
    }
    .panel {
      background: #fff;
      padding: 1.5em;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: auto;
    }
    h3 {
      margin-bottom: 1em;
    }
    input[type="text"], input[type="password"] {
      padding: 0.5em;
      margin: 0.3em 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      padding: 0.5em 1em;
      margin-top: 0.5em;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    .tree {
      margin-top: 1em;
      font-size: 0.95em;
    }
    .node {
      margin-left: 1em;
      padding: 0.3em 0;
    }
    .field {
      margin-left: 2em;
      padding: 0.2em 0;
    }
    .field input {
      width: 60%;
    }
    .toggle {
      cursor: pointer;
      color: #0077cc;
    }
  </style>
</head>
<body>

  <!-- üîê Login Panel -->
  <div id="loginPanel" class="panel">
    <h3>üîê Teacher Login</h3>
    <label>Username:</label>
    <input type="text" id="loginUsername" placeholder="e.g., joselito.vilarta" />
    <label>Password:</label>
    <input type="password" id="loginPassword" placeholder="Enter your password" />
    <button onclick="authenticateUser()">üîì Login</button>
  </div>

  <!-- üóÇÔ∏è Firestore Explorer -->
  <div id="explorerPanel" class="panel hidden">
    <h3>üóÇÔ∏è Firestore Explorer</h3>
    <div id="treeRoot" class="tree"></div>
  </div>

  <script type="module">
    (async () => {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js");
      const { getFirestore, collection, getDocs, doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
        authDomain: "jlvcpa-quizzes.firebaseapp.com",
        projectId: "jlvcpa-quizzes",
        storageBucket: "jlvcpa-quizzes.appspot.com",
        messagingSenderId: "629158256557",
        appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      window.db = db;

      // üîê Authentication
      window.authenticateUser = async function () {
        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value.trim();

        const teachersRef = collection(db, "teachers");
        const snapshot = await getDocs(teachersRef);
        let authenticated = false;

        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.userName === username && data.passWord === password) {
            authenticated = true;
          }
        });

        if (authenticated) {
          document.getElementById("loginPanel").classList.add("hidden");
          document.getElementById("explorerPanel").classList.remove("hidden");
          loadCollections("root", null, document.getElementById("treeRoot"));
        } else {
          alert("‚ùå Invalid credentials.");
        }
      };

      // üìÅ Load collections/documents recursively
      async function loadCollections(label, parentRef, container) {
        const colRef = parentRef ? collection(parentRef, label) : collection(db, label);
        const colSnap = await getDocs(colRef);

        const node = document.createElement("div");
        node.className = "node";
        node.innerHTML = `<span class="toggle">üìÅ ${label}</span>`;
        container.appendChild(node);

        const children = document.createElement("div");
        children.className = "hidden";
        node.appendChild(children);

        node.querySelector(".toggle").onclick = () => {
          children.classList.toggle("hidden");
        };

        for (const docSnap of colSnap.docs) {
          const docNode = document.createElement("div");
          docNode.className = "node";
          docNode.innerHTML = `<span class="toggle">üìÑ ${docSnap.id}</span>`;
          children.appendChild(docNode);

          const docChildren = document.createElement("div");
          docChildren.className = "hidden";
          docNode.appendChild(docChildren);

          docNode.querySelector(".toggle").onclick = () => {
            docChildren.classList.toggle("hidden");
          };

          const data = docSnap.data();
          Object.entries(data).forEach(([key, value]) => {
            const field = document.createElement("div");
            field.className = "field";
            field.innerHTML = `
              <label><strong>${key}</strong></label>
              <input type="text" value="${JSON.stringify(value)}" />
              <button>üíæ Save</button>
            `;
            field.querySelector("button").onclick = async () => {
              let parsed;
              try {
                parsed = JSON.parse(field.querySelector("input").value);
              } catch {
                alert("‚ö†Ô∏è Invalid JSON format.");
                return;
              }
              await setDoc(doc(docRef(colRef, docSnap.id)), { [key]: parsed }, { merge: true });
              alert(`‚úÖ Saved "${key}"`);
            };
            docChildren.appendChild(field);
          });

          // üîÅ Recursively load subcollections
          const subcollections = await docSnap.ref.listCollections();
          for (const sub of subcollections) {
            await loadCollections(sub.id, docSnap.ref, docChildren);
          }
        }
      }

      function docRef(colRef, docId) {
        return doc(colRef, docId);
      }
    })();
  </script>

</body>
</html>
