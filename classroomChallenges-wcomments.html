<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Constructed Response Quiz Generator</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f4f4f4;
      max-width: 1000px;
      margin: auto;
    }
    h2 {
      color: #007acc;
      text-align: center;
    }
    select, button {
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    .panel {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
    }
    .header {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
      color: #007acc;
    }
    .question-item {
      margin-bottom: 10px;
      padding: 5px;
      border-bottom: 1px dashed #ccc;
    }
    .student {
      margin: 5px 0;
    }
    .active { color: green; }
    .inactive { color: gray; }
  </style>
</head>
<body>
  <h2>Constructed Response Quiz Generator</h2>

  <label for="selectAttendanceRecord">Select Attendance Record:</label>
  <select id="selectAttendanceRecord">
    <option value="">-- Choose Section --</option>
  </select>

  <div id="studentList" class="panel">
    <div class="header">Student List</div>
  </div>

  <button onclick="createGroups()">Create Groups</button>

  <div class="panel">
    <div class="header">Group 1</div>
    <div id="group1Members"></div>
  </div>
  <div class="panel">
    <div class="header">Group 2</div>
    <div id="group2Members"></div>
  </div>
  <div class="panel">
    <div class="header">Group 3</div>
    <div id="group3Members"></div>
  </div>

  <button onclick="generateQuiz()">Generate Quiz</button>

  <div class="panel allQuestions-panel">
    <div class="header">All Questions</div>
    <div class="allQuestionsList" id="allQuestionsList">
      [All Questions for students discussion before the game starts will load here]
    </div>
  </div>

  <script type="module">
    (async () => {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js");
      const { getFirestore, collection, getDocs, doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
        authDomain: "jlvcpa-quizzes.firebaseapp.com",
        projectId: "jlvcpa-quizzes",
        storageBucket: "jlvcpa-quizzes.appspot.com",
        messagingSenderId: "629158256557",
        appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const selectAttendance = document.getElementById("selectAttendanceRecord");
      const studentList = document.getElementById("studentList");

// 🔗 Get reference to the attendance dropdown
const selectAttendance = document.getElementById("selectAttendanceRecord");

// 🔗 Get reference to the student list container
const studentList = document.getElementById("studentList");

// 📦 Initialize an empty array to store all questions from questionBank
let questionBank = [];

// 📥 Load all questions from the "questionBank" collection in Firestore
async function loadQuestionBank() {
  const snapshot = await getDocs(collection(db, "questionBank")); // Fetch all documents
  questionBank = []; // Reset array
  snapshot.forEach(doc => {
    questionBank.push(doc.data()); // Push each question object into the array
  });
}

// 📥 Load the 3 most recent attendance records from Firestore
async function loadRecentAttendanceRecords() {
  const snapshot = await getDocs(collection(db, "attendance")); // Fetch all attendance docs
  const records = [];

  snapshot.forEach(doc => {
    const [section, date] = doc.id.split("_"); // Extract section and date from doc ID
    records.push({ id: doc.id, section, date }); // Store structured record
  });

  records.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
  const recent = records.slice(0, 3); // Take top 3 records

  recent.forEach(record => {
    const option = document.createElement("option"); // Create dropdown option
    option.value = record.id; // Set value to doc ID
    option.textContent = `${record.section} - ${record.date}`; // Display section and date
    selectAttendance.appendChild(option); // Add to dropdown
  });
}

// 📥 Load students from selected attendance record
async function loadStudents(docId) {
  studentList.innerHTML = ""; // Clear previous student list

  const attendanceDoc = await getDoc(doc(db, "attendance", docId)); // Fetch attendance doc
  if (!attendanceDoc.exists()) return; // Exit if not found

  const data = attendanceDoc.data(); // Get document data
  const students = data.students || []; // Get students array

  students.forEach(student => {
    const { fullName, status } = student; // Destructure student info
    const div = document.createElement("div"); // Create student div
    div.className = `student ${status === "A" ? "inactive" : "active"}`; // Style based on status
    div.textContent = `${fullName} - ${status}`; // Display name and status
    div.dataset.fullName = fullName; // Store name in dataset
    div.dataset.status = status; // Store status in dataset
    studentList.appendChild(div); // Add to student list
  });
}

// 🎲 Randomly assign active students to 3 groups
window.createGroups = function () {
  const activeStudents = Array.from(document.querySelectorAll(".student.active")); // Get active students
  const shuffled = activeStudents.sort(() => Math.random() - 0.5); // Shuffle randomly

  const groups = [[], [], []]; // Initialize 3 empty groups

  shuffled.forEach((student, i) => {
    groups[i % 3].push(student); // Distribute students evenly
    student.classList.add("inactive"); // Mark as assigned
    student.classList.remove("active");
  });

  // 🧑‍🤝‍🧑 Display group members
  document.getElementById("group1Members").innerHTML = groups[0].map(s => s.textContent).join("<br>");
  document.getElementById("group2Members").innerHTML = groups[1].map(s => s.textContent).join("<br>");
  document.getElementById("group3Members").innerHTML = groups[2].map(s => s.textContent).join("<br>");
};

// 🔄 When attendance record changes, load corresponding students
selectAttendance.addEventListener("change", e => {
  if (e.target.value) {
    loadStudents(e.target.value); // Load students for selected record
  }
});

// 🎯 Select 20 random constructed-response questions
function getRandomQuestions(bank, count = 20) {
  const constructed = bank.filter(q => q.testType === "Constructed-Response"); // Filter by type
  return constructed.sort(() => Math.random() - 0.5).slice(0, count); // Shuffle and slice
}

// 🖼️ Render selected questions to the allQuestions panel
function renderQuestionsToPanel(questions) {
  const container = document.getElementById("allQuestionsList"); // Get panel container
  container.innerHTML = ""; // Clear previous content

  questions.forEach((q, i) => {
    const div = document.createElement("div"); // Create question item
    div.className = "question-item";
    div.innerHTML = `<strong>Q${i + 1}:</strong> ${q.question}`; // Display question text
    container.appendChild(div); // Add to panel
  });
}

// 💾 Save selected questions to "quizzes" collection in Firestore
async function saveQuiz(section, questions) {
  const date = new Date().toISOString().split("T")[0]; // Format current date
  const docID = `${section}_${date}`; // Create doc ID

  const quizData = {
    instructions: "Answer each question based on your understanding of transaction analysis.", // Quiz instructions
    section, // Section name
    date, // Quiz date
    topic: "Transaction Analysis", // Topic label
    type: "Constructed-Response", // Question type
    questions // Array of selected questions
  };

  await setDoc(doc(db, "quizzes", docID), quizData); // Save to Firestore
  console.log(`✅ Quiz saved to quizzes/${docID}`); // Log success
}

// 🚀 Generate quiz for selected section
window.generateQuiz = async function () {
  const selected = selectAttendance.value; // Get selected attendance record
  if (!selected) {
    alert("Please select a section."); // Warn if none selected
    return;
  }

  const [section] = selected.split("_"); // Extract section name
  await loadQuestionBank(); // Load all questions
  const selectedQuestions = getRandomQuestions(questionBank, 20); // Pick 20 random ones
  renderQuestionsToPanel(selectedQuestions); // Display in panel
  await saveQuiz(section, selectedQuestions); // Save to Firestore
};

// 🔄 Initial load: fetch questions and attendance records
loadQuestionBank();
loadRecentAttendanceRecords();
    })();
  </script>
</body>
</html>
